<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Class Routine</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body { -webkit-font-smoothing: antialiased; }
table { border-collapse: collapse; width: 100%; table-layout: fixed; }
th, td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: center; vertical-align: middle; word-wrap: break-word; font-weight: 600; }
td[contenteditable="true"]:focus { outline: 2px solid #3b82f6; background: #e0f2fe; }
thead th { position: sticky; top: 0; z-index: 10; }
.container { max-width: 1100px; width: 100%; }

/* Mobile layout */
.mobile-view { display: none; }
@media (max-width: 768px) {
  table { display: none; }
  .mobile-view { display: grid; grid-template-columns: 1fr; gap: 1rem; width: 100%; }
  .mobile-day { background: white; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 1rem; text-align: center; }
  .mobile-day h2 { font-weight: 700; color: #2563eb; font-size: 1.25rem; margin-bottom: 0.75rem; }
  .time-slot { background: #e0f2fe; border: 1px solid #3b82f6; border-radius: 0.75rem; padding: 0.75rem; margin-bottom: 0.5rem; font-weight: 600; text-align: center; white-space: pre-wrap; word-break: break-word; line-height: 1.4; }
  .time-label { display: block; font-size: 0.9rem; font-weight: 700; color: #1e3a8a; margin-bottom: 0.3rem; }
}
</style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
<div class="container">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-3xl font-bold text-blue-700">Class Routine</h1>
    <div class="flex items-center gap-3">
      <span id="adminStatus" class="text-sm text-gray-600 hidden">ðŸŸ¢ Admin Mode Active</span>
      <button id="loginBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Admin Login</button>
    </div>
  </div>

  <div class="flex gap-3 mb-4">
    <button id="exportPDF" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Export to PDF</button>
    <button id="resetRoutine" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 hidden">Reset Routine</button>
  </div>

  <!-- Desktop Table -->
  <div class="overflow-auto bg-white rounded-2xl shadow">
    <table id="routineTable" class="min-w-full">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="w-36">Day</th>
          <th>8:00-8:50</th>
          <th>8:50-9:40</th>
          <th>9:40-10:30</th>
          <th>10:50-11:40</th>
          <th>11:40-12:30</th>
          <th>12:30-1:20</th>
          <th>2:30-3:20</th>
          <th>3:20-4:10</th>
          <th>4:10-5:00</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Mobile View -->
  <div id="mobileView" class="mobile-view"></div>

  <p class="mt-3 text-sm text-gray-600">Only admin can edit (desktop only). Use <code>colspan=2</code> to merge time slots. Shift+Enter adds a new line.</p>
</div>

<script>
/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyATtftn1Y0WT0EezeYAwYZ_msIiObHul3A",
  authDomain: "routine-087.firebaseapp.com",
  projectId: "routine-087",
  storageBucket: "routine-087.firebasestorage.app",
  messagingSenderId: "186071694349",
  appId: "1:186071694349:web:8d83d141a476753463a944",
  measurementId: "G-4F1LCHGZTJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("classRoutine");

/* ---------------- Core Logic ---------------- */
const ADMIN_PASSWORD = "Shahriar#087";
let isAdmin = false;
const days = ["Saturday","Sunday","Monday","Tuesday","Wednesday"];
const times = ["8:00-8:50","8:50-9:40","9:40-10:30","10:50-11:40","11:40-12:30","12:30-1:20","2:30-3:20","3:20-4:10","4:10-5:00"];
const tbody = document.querySelector('#routineTable tbody');
const mobileView = document.getElementById('mobileView');
const loginBtn = document.getElementById('loginBtn');
const adminStatus = document.getElementById('adminStatus');
const resetBtn = document.getElementById('resetRoutine');

function createTable(data){
  tbody.innerHTML='';
  days.forEach((day, r)=>{
    const tr=document.createElement('tr');
    const dayCell=document.createElement('td');
    dayCell.textContent=day;
    dayCell.classList.add('font-semibold','bg-gray-50');
    tr.appendChild(dayCell);
    times.forEach((_,c)=>{
      const td=document.createElement('td');
      td.dataset.col=c;
      td.style.fontWeight='600';
      td.contentEditable=isAdmin;
      if(data && data[r] && data[r][c] && !data[r][c].covered){
        td.innerText=data[r][c].text||'';
        if(data[r][c].colspan>1) td.colSpan=data[r][c].colspan;
      }
      attachHandlers(td);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  renderMobile(data || []);
}

function attachHandlers(td){
  td.addEventListener('keydown', e=>{
    if(!isAdmin) return e.preventDefault();
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); td.blur(); }
  });
  td.addEventListener('blur', ()=>{
    if(!isAdmin) return;
    handleSpan(td);
    saveToFirebase();
  });
}

function handleSpan(cell){
  const txt = cell.innerText.trim();
  const m = txt.match(/colspan=(\d+)/i);
  if(!m) return;
  const span = parseInt(m[1]);
  if(!span||span<2){ cell.innerText = txt.replace(/colspan=\d+/i,'').trim(); return; }
  const row = cell.parentElement;
  let colIndex = Array.from(row.children).slice(1).indexOf(cell);
  if(colIndex===-1) return;
  cell.colSpan = span;
  cell.innerText = txt.replace(/colspan=\d+/i,'').trim();
  for(let i=0;i<span-1;i++){ const next=cell.nextElementSibling; if(!next) break; next.remove(); }
}

function getRoutineData(){
  const rows=[];
  document.querySelectorAll('#routineTable tbody tr').forEach(row=>{
    const rowData = new Array(times.length).fill(null);
    const visible = Array.from(row.children).slice(1);
    let colPtr=0;
    visible.forEach(cell=>{
      while(colPtr<times.length && rowData[colPtr]!==null) colPtr++;
      if(colPtr>=times.length) return;
      const colspan=cell.colSpan||1;
      rowData[colPtr]={text:cell.innerText,colspan};
      for(let k=1;k<colspan;k++) rowData[colPtr+k]={covered:true};
      colPtr+=colspan;
    });
    rows.push(rowData);
  });
  return rows;
}

function saveToFirebase(){
  const data=getRoutineData();
  db.set(data);
}

function renderMobile(data){
  mobileView.innerHTML='';
  days.forEach((day,r)=>{
    const card=document.createElement('div');
    card.className='mobile-day';
    card.innerHTML=`<h2>${day}</h2>`;
    const row=data[r]||[];
    let c=0;
    while(c<times.length){
      const cell=row[c];
      if(!cell || cell.covered){ c++; continue; }
      const colspan=cell.colspan||1;
      const timeStart = times[c].split('-')[0];
      const timeEnd = colspan>1 ? times[c+colspan-1].split('-')[1] : times[c].split('-')[1];
      const block=document.createElement('div');
      block.className='time-slot';
      block.innerHTML = `<span class="time-label">${timeStart} - ${timeEnd}</span>${(cell.text||'').replace(/\n/g,'<br>')}`;
      card.appendChild(block);
      c+=colspan;
    }
    mobileView.appendChild(card);
  });
}

/* ---------------- Firebase Sync ---------------- */
db.on('value', snapshot=>{
  const data=snapshot.val();
  createTable(data);
});

/* ---------------- UI Buttons ---------------- */
loginBtn.addEventListener('click', ()=>{
  if(isAdmin){
    isAdmin=false;
    adminStatus.classList.add('hidden');
    loginBtn.textContent='Admin Login';
    resetBtn.classList.add('hidden');
    createTable(getRoutineData());
    return;
  }
  const pwd=prompt('Enter admin password:');
  if(pwd===ADMIN_PASSWORD){
    isAdmin=true;
    adminStatus.classList.remove('hidden');
    loginBtn.textContent='Logout';
    resetBtn.classList.remove('hidden');
    createTable(getRoutineData());
    alert('âœ… Admin mode activated.');
  } else alert('Incorrect password.');
});

resetBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Admin only.');
  if(!confirm('Reset routine?')) return;
  db.set({});
});

document.getElementById('exportPDF').addEventListener('click', async ()=>{
  const el=document.querySelector('#routineTable');
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL('image/png');
  const pdf=new jspdf.jsPDF('l','pt','a4');
  const pageWidth=pdf.internal.pageSize.getWidth();
  const imgWidth=pageWidth-40;
  const imgHeight=(canvas.height*imgWidth)/canvas.width;
  pdf.addImage(img,'PNG',20,20,imgWidth,imgHeight);
  pdf.save('Class_Routine.pdf');
});
</script>
</body>
</html>
