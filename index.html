<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Routine | CSE B | 24</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  body { -webkit-font-smoothing: antialiased; }
  table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  th, td {
    border: 1px solid #d1d5db;
    padding: 0.5rem;
    text-align: center;
    vertical-align: middle;
    word-wrap: break-word;
    font-weight: 700; /* Bold text */
  }
  td[contenteditable="true"]:focus { outline: 2px solid #3b82f6; background: #e0f2fe; }
  thead th { position: sticky; top: 0; z-index: 10; }
  .container { max-width: 1100px; width: 100%; }
  td { white-space: pre-wrap; word-break: break-word; }

  /* ===== MOBILE VIEW ===== */
  @media (max-width: 768px) {
    #routineTable { display: none; }
    #mobileView { display: block; }
    #dayTabs {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      background: #f1f5f9;
      border-radius: 9999px;
      padding: 0.3rem;
      margin-bottom: 1rem;
    }
    .day-tab {
      flex: 1;
      text-align: center;
      padding: 0.4rem 0.6rem;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.95rem;
      color: #1e3a8a;
      background: #e0e7ff;
      cursor: pointer;
      transition: all 0.25s ease;
      user-select: none;
    }
    .day-tab.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 2px 8px rgba(59,130,246,0.28);
    }
    #dayContent {
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 1rem;
      transition: all 0.25s ease;
    }
    .time-slot-card {
      background: #f0f9ff;
      border-left: 4px solid #3b82f6;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.6rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .time-label {
      font-weight: 700;
      font-size: 0.9rem;
      color: #2563eb;
      margin-bottom: 0.25rem;
    }
    .slot-text {
      font-size: 0.96rem;
      color: #0f172a;
      line-height: 1.35rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: 700;
      margin: 0;
    }
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
<div class="container">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-3xl font-bold text-blue-700">Class Routine (Section B)</h1>
    <div class="flex items-center gap-3">
      <span id="adminStatus" class="text-sm text-gray-600 hidden">ðŸŸ¢ Admin Mode Active</span>
      <button id="loginBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Admin Login</button>
    </div>
  </div>

  <div class="flex gap-3 mb-4">
    <button id="exportPDF" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Export to PDF</button>
    <button id="resetRoutine" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 hidden">Reset Routine</button>
    <button id="clearStorage" class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 hidden">Clear Saved Data</button>
  </div>

  <!-- Desktop Table -->
  <div class="overflow-auto bg-white rounded-2xl shadow w-full">
    <table id="routineTable" class="min-w-full">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="w-36">Day</th>
          <th>8:00-8:50</th>
          <th>8:50-9:40</th>
          <th>9:40-10:30</th>
          <th>10:50-11:40</th>
          <th>11:40-12:30</th>
          <th>12:30-1:20</th>
          <th>2:30-3:20</th>
          <th>3:20-4:10</th>
          <th>4:10-5:00</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Mobile Tabs View -->
  <div id="mobileView" class="hidden w-full">
    <div id="dayTabs"></div>
    <div id="dayContent"></div>
  </div>

  <p class="mt-3 text-sm text-gray-600 text-center">
    Viewable by everyone. Only admin can edit on desktop. Type <code>colspan=2</code> on desktop to merge time slots. Shift+Enter inserts new line.
  </p>
</div>

<script>
const ADMIN_PASSWORD = "Sh@hriar#087";
let isAdmin = false;
const days = ["Saturday","Sunday","Monday","Tuesday","Wednesday"];
const times = ["8:00-8:50","8:50-9:40","9:40-10:30","10:50-11:40","11:40-12:30","12:30-1:20","2:30-3:20","3:20-4:10","4:10-5:00"];
const STORAGE_KEY = 'classRoutine_v7';

const tbody = document.querySelector('#routineTable tbody');
const loginBtn = document.getElementById('loginBtn');
const adminStatus = document.getElementById('adminStatus');
const resetBtn = document.getElementById('resetRoutine');
const clearBtn = document.getElementById('clearStorage');

function normalizeHtmlForMobile(rawHtml){
  if(!rawHtml) return '';
  let html = rawHtml.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
  html = html.replace(/<\/(div|p|li|tr|h[1-6])>/gi, '<br>');
  html = html.replace(/<(div|p|li|tr|h[1-6])[^>]*>/gi, '');
  html = html.replace(/(<br>\s*){3,}/gi, '<br><br>');
  html = html.replace(/^(<br>\s*)+/i, '').replace(/(<br>\s*)+$/i, '');
  return html;
}

function createTable(){
  tbody.innerHTML = '';
  days.forEach(day=>{
    const tr = document.createElement('tr');
    const dayCell = document.createElement('td');
    dayCell.textContent = day;
    dayCell.classList.add('font-semibold','bg-gray-50');
    tr.appendChild(dayCell);
    times.forEach((_, c) => {
      const td = document.createElement('td');
      td.dataset.col = c;
      td.contentEditable = isAdmin;
      td.setAttribute('spellcheck', 'false');
      attachCellHandlers(td);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function attachCellHandlers(td){
  td.addEventListener('keydown', e=>{
    if(!isAdmin) return e.preventDefault();
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); td.blur(); }
  });
  td.addEventListener('blur', ()=>{
    if(!isAdmin) return;
    handleSpanFromText(td);
    saveRoutine();
  });
  td.addEventListener('paste', ev => {
    if(!isAdmin){ ev.preventDefault(); return; }
    ev.preventDefault();
    const text = (ev.clipboardData || window.clipboardData).getData('text');
    const html = text.replace(/\n/g, '<br>');
    insertHtmlAtCaret(html);
  });
}

function insertHtmlAtCaret(html) {
  const sel = window.getSelection();
  if (!sel || !sel.getRangeAt || sel.rangeCount === 0) return;
  const range = sel.getRangeAt(0);
  range.deleteContents();
  const el = document.createElement('div');
  el.innerHTML = html;
  const frag = document.createDocumentFragment();
  let node, lastNode;
  while ((node = el.firstChild)) { lastNode = frag.appendChild(node); }
  range.insertNode(frag);
  if (lastNode) {
    range.setStartAfter(lastNode);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

function handleSpanFromText(cell){
  const txt = cell.innerText || '';
  const m = txt.match(/colspan=(\d+)/i);
  if(!m) return;
  const span = parseInt(m[1], 10);
  if(!span || span < 2){
    cell.innerHTML = (cell.innerHTML || '').replace(/colspan=\d+/i, '');
    return;
  }
  const row = cell.parentElement;
  let colIndex = Array.from(row.children).slice(1).indexOf(cell);
  if(colIndex === -1) return;
  const cleanedHtml = (cell.innerHTML || '').replace(/colspan=\d+/i,'');
  cell.colSpan = span;
  cell.innerHTML = cleanedHtml;
  for(let i=0;i<span-1;i++){
    const next = cell.nextElementSibling;
    if(!next) break;
    next.remove();
  }
}

function saveRoutine(){
  const rows = [];
  document.querySelectorAll('#routineTable tbody tr').forEach(row=>{
    const rowData = new Array(times.length).fill(null);
    const visible = Array.from(row.children).slice(1);
    let colPtr = 0;
    visible.forEach(cell=>{
      while(colPtr < times.length && rowData[colPtr] !== null) colPtr++;
      if(colPtr >= times.length) return;
      const colspan = cell.colSpan || 1;
      rowData[colPtr] = { html: cell.innerHTML, colspan };
      for(let k=1;k<colspan;k++) rowData[colPtr+k] = { covered: true };
      colPtr += colspan;
    });
    rows.push(rowData);
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  renderMobileView();
}

function loadRoutine(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const rows = JSON.parse(raw);
    tbody.innerHTML = '';
    rows.forEach((rowData, r) => {
      const tr = document.createElement('tr');
      const dayCell = document.createElement('td');
      dayCell.textContent = days[r] || ('Day ' + (r+1));
      dayCell.classList.add('font-semibold','bg-gray-50');
      tr.appendChild(dayCell);

      for(let c=0;c<times.length;c++){
        const cellInfo = rowData[c];
        if(!cellInfo){
          const td = document.createElement('td');
          td.dataset.col = c;
          td.contentEditable = isAdmin;
          attachCellHandlers(td);
          tr.appendChild(td);
        } else if(cellInfo.covered){
          continue;
        } else {
          const td = document.createElement('td');
          td.dataset.col = c;
          td.contentEditable = isAdmin;
          td.innerHTML = cellInfo.html || '';
          if(cellInfo.colspan && cellInfo.colspan > 1) td.colSpan = cellInfo.colspan;
          attachCellHandlers(td);
          tr.appendChild(td);
        }
      }

      tbody.appendChild(tr);
    });
    renderMobileView();
    return true;
  } catch (e){
    console.error('Failed to load routine:', e);
    return false;
  }
}

function renderMobileView() {
  const mobileView = document.getElementById('mobileView');
  const dayTabs = document.getElementById('dayTabs');
  const dayContent = document.getElementById('dayContent');

  if (!mobileView) return;
  if (window.innerWidth > 768) { mobileView.style.display = 'none'; return; }
  mobileView.style.display = 'block';

  dayTabs.innerHTML = '';
  dayContent.innerHTML = '';

  days.forEach((day, index) => {
    const btn = document.createElement('button');
    btn.className = 'day-tab';
    btn.textContent = day;
    btn.addEventListener('click', () => switchDay(index));
    dayTabs.appendChild(btn);
  });

  switchDay(0);

  function switchDay(dayIndex){
    const tabs = document.querySelectorAll('.day-tab');
    tabs.forEach(t => t.classList.remove('active'));
    if(tabs[dayIndex]) tabs[dayIndex].classList.add('active');

    dayContent.innerHTML = '';
    const row = document.querySelectorAll('#routineTable tbody tr')[dayIndex];
    if(!row) return;

    let c = 0;
    Array.from(row.children).slice(1).forEach((td) => {
      const colspan = td.colSpan || 1;
      const rawHtml = td.innerHTML || '';
      const stripped = rawHtml.replace(/<br\s*\/?>/gi, '').replace(/&nbsp;/gi, '').replace(/<[^>]*>/g, '').trim();
      if(!stripped){ c += colspan; return; }

      const card = document.createElement('div');
      card.className = 'time-slot-card';

      const label = document.createElement('div');
      label.className = 'time-label';

      // FIXED: For merged cells show "start - end"
      if (colspan > 1) {
        const startTime = times[c].split('-')[0];
        const endTime = times[c + colspan - 1].split('-')[1];
        label.textContent = `${startTime} - ${endTime}`;
      } else {
        label.textContent = times[c];
      }

      const content = document.createElement('div');
      content.className = 'slot-text';
      content.innerHTML = normalizeHtmlForMobile(rawHtml);

      card.appendChild(label);
      card.appendChild(content);
      dayContent.appendChild(card);

      c += colspan;
    });
  }
}

function setEditable(state){
  document.querySelectorAll('#routineTable td').forEach(td=>{
    if(td.cellIndex !== 0) td.contentEditable = state;
  });
}

loginBtn.addEventListener('click', ()=>{
  if(isAdmin){
    isAdmin = false;
    adminStatus.classList.add('hidden');
    loginBtn.textContent = 'Admin Login';
    resetBtn.classList.add('hidden');
    clearBtn.classList.add('hidden');
    setEditable(false);
    renderMobileView();
    return;
  }
  const pwd = prompt('Enter admin password:');
  if(pwd === ADMIN_PASSWORD){
    isAdmin = true;
    adminStatus.classList.remove('hidden');
    loginBtn.textContent = 'Logout';
    resetBtn.classList.remove('hidden');
    clearBtn.classList.remove('hidden');
    setEditable(true);
    renderMobileView();
    alert('Admin mode activated.');
  } else {
    alert('Incorrect password.');
  }
});

document.getElementById('exportPDF').addEventListener('click', async ()=>{
  const el = document.querySelector('#routineTable');
  const canvas = await html2canvas(el, { scale: 2 });
  const img = canvas.toDataURL('image/png');
  const pdf = new jspdf.jsPDF('l','pt','a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgWidth = pageWidth - 40;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  pdf.addImage(img, 'PNG', 20, 20, imgWidth, imgHeight);
  pdf.save('Class_Routine.pdf');
});

resetBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Admin only.');
  if(!confirm('Reset routine to empty table?')) return;
  localStorage.removeItem(STORAGE_KEY);
  createTable();
  renderMobileView();
});

clearBtn.addEventListener('click', ()=>{
  if(!isAdmin) return alert('Admin only.');
  if(!confirm('Clear saved data?')) return;
  localStorage.removeItem(STORAGE_KEY);
  alert('Saved data cleared.');
});

const loaded = loadRoutine();
if(!loaded) createTable();
window.addEventListener('beforeunload', saveRoutine);
window.addEventListener('resize', renderMobileView);
</script>
</body>
</html>
